<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìä Planificaci√≥n Rio Segundo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- XLSX para leer / generar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase (compat, funciona bien en HTML est√°tico local) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body{
      margin:0;
      background:#e5e7eb;
      color:#111827;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    main{
      width:100%;
      max-width:100%;
      margin:0;
      padding:.4rem .6rem .9rem;
    }

    label{
      font-size:.78rem;
      opacity:.9;
    }
    input,select,button{
      padding:.32rem .55rem;
      border-radius:.5rem;
      border:1px solid #9ca3af;
      background:#f9fafb;
      color:#111827;
      font-size:.78rem;
    }
    select{
      cursor:pointer;
    }
    select:focus, input:focus{
      outline:none;
      box-shadow:0 0 0 2px rgba(59,130,246,.45);
      border-color:#2563eb;
      background:#ffffff;
    }
    input[type="file"]{
      padding:.15rem;
      background:transparent;
      border:none;
    }
    button{
      cursor:pointer;
      border:none;
      background:#16a34a;
      color:#ecfdf5;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.25rem;
      border-radius:999px;
      padding:.4rem .9rem;
      transition:transform .06s ease, box-shadow .06s ease, background .1s ease;
      box-shadow:0 2px 6px rgba(22,163,74,.25);
      white-space:nowrap;
      font-size:.78rem;
    }
    button:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(22,163,74,.28);
    }
    button.secondary{
      background:#e5e7eb;
      color:#111827;
      box-shadow:0 2px 6px rgba(148,163,184,.25);
    }
    button.secondary:hover:not(:disabled){
      box-shadow:0 4px 10px rgba(148,163,184,.35);
    }
    button.danger{
      background:#ef4444;
      color:#fef2f2;
      box-shadow:0 2px 6px rgba(248,113,113,.35);
    }
    button.danger:hover:not(:disabled){
      box-shadow:0 4px 10px rgba(248,113,113,.45);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:.7rem;
      align-items:flex-end;
      margin-bottom:.7rem;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:.15rem;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:.6rem;
      margin-bottom:.6rem;
      flex-wrap:wrap;
      justify-content:center;
    }
    .tab-btn{
      padding:.35rem 1rem;
      border-radius:999px;
      border:1px solid #cbd5f5;
      background:#ffffff;
      font-size:.8rem;
      cursor:pointer;
      display:flex;
      gap:.35rem;
      align-items:center;
      justify-content:center;
      transition:background .12s ease, color .12s ease, box-shadow .12s ease, border-color .12s ease, transform .06s ease;
      box-shadow:0 1px 4px rgba(15,23,42,.08);
      color:#111827;
    }
    .tab-btn.active{
      background:#16a34a;
      color:#ffffff;
      border-color:#16a34a;
      box-shadow:0 3px 8px rgba(22,163,74,.3);
    }
    .tab-btn:hover{
      transform:translateY(-1px);
    }

    /* CARDS */
    .card{
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:.9rem;
      padding:.7rem .85rem .85rem;
      margin-bottom:.6rem;
      box-shadow:0 6px 16px rgba(15,23,42,.08);
    }
    .card h2{
      margin:0 0 .7rem;
      font-size:.98rem;
      display:flex;
      gap:.4rem;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    /* TABLAS */
    .table-wrap{
      overflow:auto;
      border-radius:.8rem;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      margin-top:.35rem;
    }

    /* tabla principal: scroll propio + sticky header */
    #tab-plan .table-wrap{
      overflow-x:auto;
      overflow-y:auto;
      max-height:calc(100vh - 260px);
    }

    table{
      border-collapse:collapse;
      width:100%;
      font-size:.70rem;
      min-width:900px;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:.2rem .35rem;
      white-space:nowrap;
      background:#ffffff;
      vertical-align:middle;
      min-width:52px;
    }
    th{
      background:#f1f5f9;
      font-weight:600;
      text-align:center;
      color:#0f172a;
    }
    td{
      text-align:right;
      color:#111827;
    }

    /* ===== Sticky header PRO (2 filas) ===== */
    #tabla-plan{
      --thead1h: 28px; /* fallback; se recalcula en JS */
    }
    #tabla-plan thead th{
      position: sticky;
      background:#f1f5f9;
    }
    /* fila 1 pegada arriba */
    #tabla-plan thead tr:first-child th{
      top: 0;
      z-index: 30;
    }
    /* fila 2 pegada debajo de fila 1 */
    #tabla-plan thead tr:nth-child(2) th{
      top: var(--thead1h);
      z-index: 29;
    }

    th.sticky-top{
      position:sticky;
      top:0;
      z-index:11;
    }
    th.sticky-left,
    td.sticky-left{
      position:sticky;
      left:0;
      background:#f9fafb;
      z-index:12;
      text-align:left;
    }
    th.sticky-left-2,
    td.sticky-left-2{
      position:sticky;
      left:110px;
      background:#f9fafb;
      z-index:12;
      text-align:left;
    }

    /* Intersecciones: sticky top + sticky left */
    #tabla-plan thead th.sticky-left{ z-index:40; }
    #tabla-plan thead th.sticky-left-2{ z-index:39; }

    /* columna c√≥digo */
    #tabla-plan th.codigo-col,
    #tabla-plan td.codigo-col{
      min-width:100px;
      max-width:120px;
    }

    tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:nth-child(odd) td{
      background:#ffffff;
    }
    tr:hover td:not(.line-header-cell):not(.line-subtotal-cell){
      background:#dbeafe;
    }
    /* evitar que hover ‚Äúensucie‚Äù sticky-left */
    tr:hover td.sticky-left,
    tr:hover td.sticky-left-2{
      background:#f9fafb !important;
    }

    input.cell-input{
      width:100%;
      border-radius:.35rem;
      border:1px solid #cbd5e1;
      background:#ffffff;
      color:#111827;
      padding:.12rem .2rem;
      font-size:.68rem;
      text-align:right;
      min-width:65px;
    }
    input.cell-input[readonly]{
      background:#f3f4f6;
    }

    .total-cell{
      font-weight:700;
      background:#dcfce7;
    }
    .total-cell-empty{
      background:#ffffff;
    }

    .line-header-row td{
      background:#fee2e2 !important;
      font-weight:700;
    }
    .line-header-row td.turnos-disponibles-cell{
      background:#fef9c3 !important;
    }
    .linea-balance.ok{
      color:#16a34a;
      text-align:center;
    }
    .linea-balance.over{
      color:#b91c1c;
      text-align:center;
    }

    .line-subtotal-row td{
      background:#e0f2fe !important;
      font-weight:700;
    }

    /* stock alerts */
    .stock-cell.stock-negative{
      background:#fee2e2 !important;
      color:#b91c1c;
      font-weight:600;
    }
    .stock-cell.stock-low{
      background:#fef9c3 !important;
      color:#92400e;
      font-weight:600;
    }

    /* KPI cards */
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:.7rem;
      margin:.1rem 0 .6rem;
      justify-content:flex-start;
    }
    .kpi-card{
      flex:0 0 210px;
      max-width:230px;
      background:#f9fafb;
      border-radius:.9rem;
      padding:.55rem .75rem;
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
      gap:.18rem;
      box-shadow:0 4px 10px rgba(148,163,184,.25);
      color:#0f172a;
    }
    .kpi-label{
      font-size:.72rem;
      opacity:.9;
      display:flex;
      align-items:center;
      gap:.25rem;
      justify-content:flex-start;
    }
    .kpi-value{
      font-size:1.05rem;
      font-weight:700;
      text-align:left;
    }
    .kpi-sub{
      font-size:.68rem;
      opacity:.75;
      text-align:left;
    }
    .kpi-card.ok{
      background:#ecfdf5;
      border-color:#bbf7d0;
    }
    .kpi-card.warn{
      background:#fefce8;
      border-color:#facc15;
    }
    .kpi-card.danger{
      background:#fef2f2;
      border-color:#fecaca;
    }

    /* botones mini por SKU */
    .mini-btn{
      border:none;
      background:#e5e7eb;
      border-radius:.4rem;
      padding:.05rem .3rem;
      cursor:pointer;
      font-size:.65rem;
    }
    .mini-btn.sku-note-btn.has-comment{
      background:#0ea5e9;
      color:#f0f9ff;
    }
    .sku-row-marked td{
      background:#fef3c7 !important;
    }

    /* texto sugerencia SKU */
    .sku-sugg{
      font-size:.58rem;
      color:#b91c1c;
      margin-top:1px;
    }

    #comentarios-list{
      margin-top:.4rem;
      font-size:.7rem;
      text-align:left;
    }

    @media (max-width:700px){
      main{
        padding:.5rem .35rem .9rem;
      }
      .card{
        padding:.7rem .7rem .8rem;
      }
      table{
        min-width:800px;
      }
      .kpi-row{
        justify-content:center;
      }
      #tab-plan .table-wrap{
        max-height:calc(100vh - 290px);
      }
    }

    /* ================== MODO IMPRESI√ìN AJUSTADO A A4 ================== */
    @media print{
      @page{
        size:A4 landscape;
        margin:8mm;
      }

      html, body{
        width:297mm;
        height:210mm;
      }
      body{
        background:#ffffff;
        zoom:0.75;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }

      .tabs,
      .no-print,
      .mini-btn{
        display:none !important;
      }
      main{
        max-width:none;
        margin:0;
        padding:0;
      }
      .card{
        box-shadow:none;
        border:none;
        border-radius:0;
        padding:0;
        margin:0;
      }

      .table-wrap{
        max-height:none !important;
        overflow:visible !important;
        border:none;
      }

      table{
        font-size:8px;
        min-width:0 !important;
        table-layout:auto;
      }
      th,td{
        padding:1px 2px;
      }

      th.sticky-top,
      th.sticky-left,
      th.sticky-left-2,
      td.sticky-left,
      td.sticky-left-2,
      #tabla-plan thead th{
        position:static !important;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN FULLSCREEN -->
  <div id="login-screen" style="
    position:fixed;
    inset:0;
    background:#0f172a;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:1rem;
    z-index:9999;
    color:#e5e7eb;
  ">
    <div style="background:#020617; padding:1.4rem 1.8rem; border-radius:1rem; box-shadow:0 15px 40px rgba(0,0,0,.6); min-width:260px; max-width:320px;">
      <h2 style="margin:0 0 .75rem; font-size:1.1rem; text-align:center;">
        üîê Ingreso ¬∑ Planificaci√≥n Rio Segundo
      </h2>
      <p style="margin:0 0 .9rem; font-size:.78rem; opacity:.85; text-align:center;">
        Ingres√° con tu usuario habilitado (Firebase Auth).
      </p>

      <div style="display:flex; flex-direction:column; gap:.45rem;">
        <input id="login-email" type="email" placeholder="Email" style="padding:.45rem .6rem; border-radius:.55rem; border:1px solid #4b5563; background:#020617; color:#e5e7eb; font-size:.8rem;">
        <input id="login-pass" type="password" placeholder="Contrase√±a" style="padding:.45rem .6rem; border-radius:.55rem; border:1px solid #4b5563; background:#020617; color:#e5e7eb; font-size:.8rem;">
        <button id="login-btn" style="margin-top:.25rem; padding:.45rem .8rem; border-radius:999px; border:none; background:#16a34a; color:#ecfdf5; font-weight:600; cursor:pointer; font-size:.8rem; display:flex; align-items:center; justify-content:center; gap:.35rem;">
          <span>Ingresar</span> <span>‚û°</span>
        </button>
        <div id="login-error" style="min-height:1rem; font-size:.7rem; color:#fca5a5; margin-top:.2rem;"></div>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL (oculto hasta login OK) -->
  <main style="display:none;">
    <!-- TABS -->
    <div class="tabs no-print">
      <button class="tab-btn" data-tab="lineas">üßµ L√≠neas de producci√≥n</button>
      <button class="tab-btn" data-tab="productos">üßæ Productos</button>
      <button class="tab-btn active" data-tab="plan">üìÜ Planificaci√≥n 3 meses</button>
      <button class="tab-btn" data-tab="reportes">üìà Reportes</button>
    </div>
    <!-- Bot√≥n logout -->
    <div class="no-print" style="display:flex; justify-content:flex-end; margin-bottom:.4rem;">
      <button id="btn-logout" class="secondary">üö™ Cerrar sesi√≥n</button>
    </div>

    <!-- ============ TAB L√çNEAS ============ -->
    <section id="tab-lineas" class="card no-print" style="display:none;">
      <h2>üßµ Alta y gesti√≥n de l√≠neas de producci√≥n</h2>

      <div class="row">
        <div class="field">
          <label for="l-nombre">Nombre de l√≠nea</label>
          <input id="l-nombre" placeholder="Ej: CARAMELOS BLANDOS" />
        </div>
        <button id="btn-add-linea">‚ûï Agregar l√≠nea</button>
      </div>

      <div class="table-wrap" style="max-height:260px;">
        <table>
          <thead>
          <tr>
            <th class="sticky-top sticky-left">L√≠nea</th>
            <th class="sticky-top">Acciones</th>
          </tr>
          </thead>
          <tbody id="tbody-lineas"></tbody>
        </table>
      </div>
    </section>

    <!-- ============ TAB PRODUCTOS ============ -->
    <section id="tab-productos" class="card no-print" style="display:none;">
      <h2>üßæ Maestro de productos</h2>

      <div class="row">
        <div class="field">
          <label for="p-codigo">C√≥digo</label>
          <input id="p-codigo" placeholder="Ej: 273" />
        </div>
        <div class="field" style="flex:1;">
          <label for="p-desc">Descripci√≥n</label>
          <input id="p-desc" placeholder="Ej: FLYNN PAFF TUTTI" />
        </div>
        <div class="field">
          <label for="p-linea">L√≠nea</label>
          <!-- ‚úÖ SOLO selecci√≥n (no permite escribir) -->
          <select id="p-linea">
            <option value="">‚Äî Seleccionar ‚Äî</option>
          </select>
        </div>
        <div class="field">
          <label for="p-kg">Kg x caja</label>
          <input id="p-kg" type="number" step="0.01" />
        </div>
        <div class="field">
          <label for="p-cjs">Cajas x turno</label>
          <input id="p-cjs" type="number" />
        </div>
        <button id="btn-add-prod">‚ûï Agregar SKU</button>
      </div>

      <div class="row">
        <div class="field">
          <label>üì• Importar maestro desde Excel (.xlsx)</label>
          <input type="file" id="file-excel" accept=".xlsx,.xls" />
          <small style="opacity:.75;font-size:.7rem;">
            Columnas: <b>CODIGO, DESCRIPCION, KG_X_CJA, CJS_X_TURNO</b> (opcional: LINEA)
          </small>
        </div>
        <button class="secondary" id="btn-clear-prod">üßπ Vaciar maestro y datos</button>
      </div>

      <div class="table-wrap" style="max-height:360px;">
        <table>
          <thead>
          <tr>
            <th class="sticky-top sticky-left">C√≥digo</th>
            <th class="sticky-top sticky-left-2">Descripci√≥n</th>
            <th class="sticky-top">L√≠nea</th>
            <th class="sticky-top">Kg/caja</th>
            <th class="sticky-top">Cjs/turno</th>
            <th class="sticky-top">Acciones</th>
          </tr>
          </thead>
          <tbody id="tbody-prod"></tbody>
        </table>
      </div>
    </section>

    <!-- ============ TAB PLAN ============ -->
    <section id="tab-plan" class="card">
      <!-- KPI -->
      <div class="kpi-row">
        <div class="kpi-card" id="kpi-card-pto">
          <div class="kpi-label">üì¶ PTO 3 meses (cajas)</div>
          <div class="kpi-value" id="kpi-pto">0</div>
          <div class="kpi-sub" id="kpi-pto-sub"></div>
        </div>
        <div class="kpi-card" id="kpi-card-plan">
          <div class="kpi-label">üè≠ Plan 3 meses (cajas)</div>
          <div class="kpi-value" id="kpi-plan">0</div>
          <div class="kpi-sub" id="kpi-plan-sub"></div>
        </div>
        <div class="kpi-card" id="kpi-card-turnos">
          <div class="kpi-label">‚è± Turnos usados / habilitados</div>
          <div class="kpi-value" id="kpi-turnos">‚Äì</div>
          <div class="kpi-sub" id="kpi-turnos-sub"></div>
        </div>
        <div class="kpi-card" id="kpi-card-stock">
          <div class="kpi-label">üì¶ Stock fin proyectado mes 3</div>
          <div class="kpi-value" id="kpi-stock">0</div>
          <div class="kpi-sub" id="kpi-stock-sub"></div>
        </div>
      </div>

      <div class="row no-print">
        <div class="field">
          <label for="f-anio">A√±o</label>
          <input id="f-anio" type="number" />
        </div>
        <div class="field">
          <label for="f-mes-inicio">Mes inicial (ventana 3 meses)</label>
          <select id="f-mes-inicio">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <div class="field">
          <label for="f-linea">Filtrar l√≠nea</label>
          <select id="f-linea"></select>
        </div>

        <!-- ‚úÖ buscador SKU -->
        <div class="field" style="flex:1; min-width:220px;">
          <label for="f-sku">üîé Buscar SKU (c√≥digo o descripci√≥n)</label>
          <input id="f-sku" placeholder="Ej: 273 / FLYNN / TUTTI..." />
        </div>

        <!-- ‚úÖ filtro marcados -->
        <div class="field" style="min-width:170px;">
          <label>&nbsp;</label>
          <label style="display:flex;align-items:center;gap:.45rem; cursor:pointer;">
            <input type="checkbox" id="f-only-marked" style="width:16px;height:16px; cursor:pointer;">
            ‚≠ê Solo marcados
          </label>
        </div>

        <button id="btn-aplicar" class="secondary">üîÑ Actualizar vista</button>
        <button id="btn-guardar">üíæ Guardar (Firebase)</button>
        <button id="btn-export" class="secondary">üì§ Exportar vista a Excel</button>
      </div>

      <div class="table-wrap">
        <table id="tabla-plan"></table>
      </div>

      <div id="comentarios-list"></div>
    </section>

    <!-- ============ TAB REPORTES ============ -->
    <section id="tab-reportes" class="card" style="display:none;">
      <h2>üìà Reportes por l√≠nea ¬∑ cajas & toneladas</h2>
      <p class="no-print" style="font-size:.72rem;opacity:.8;margin-top:0;margin-bottom:.4rem;text-align:center;">
        Ventana de 3 meses seg√∫n A√±o + Mes inicial seleccionados en la pesta√±a de planificaci√≥n.
      </p>
      <div class="table-wrap">
        <table id="tabla-reportes"></table>
      </div>

      <h3 style="font-size:.85rem;margin:.8rem 0 .3rem;text-align:center;">üìÖ Resumen anual por l√≠nea (PTO / Plan ¬∑ cajas & tn)</h3>
      <div class="table-wrap">
        <table id="tabla-reportes-anual"></table>
      </div>
    </section>
  </main>

  <script>
    // ------------------ FIREBASE INIT (compat) + LOGIN ------------------ //
    const firebaseConfig = {
      apiKey: "AIzaSyCElhjBq_8WxvQt7DTqTJ9mvIWY0B6LIBI",
      authDomain: "plantrimrio2.firebaseapp.com",
      projectId: "plantrimrio2",
      storageBucket: "plantrimrio2.firebasestorage.app",
      messagingSenderId: "697072792520",
      appId: "1:697072792520:web:ba0b81ca49c351ae3fc6fd"
    };

    let db = null;
    let auth = null;
    let firebaseEnabled = true;

    const loginScreen = document.getElementById("login-screen");
    const mainEl = document.querySelector("main");
    const loginBtn = document.getElementById("login-btn");
    const loginEmail = document.getElementById("login-email");
    const loginPass = document.getElementById("login-pass");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("btn-logout");

    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();

      auth.setPersistence(firebase.auth.Auth.Persistence.SESSION).catch(function(err){
        console.error("Error seteando persistencia:", err);
      });

      auth.onAuthStateChanged(function(user){
        if(user){
          if(loginScreen) loginScreen.style.display = "none";
          if(mainEl) mainEl.style.display = "block";
          loadStateFromFirebase(true);
        }else{
          if(loginScreen) loginScreen.style.display = "flex";
          if(mainEl) mainEl.style.display = "none";
        }
      });
    }catch(e){
      console.error("Error inicializando Firebase:", e);
      firebaseEnabled = false;
      if(loginScreen) loginScreen.style.display = "none";
      if(mainEl) mainEl.style.display = "block";
    }

    if(loginBtn){
      loginBtn.addEventListener("click", async function(){
        if(!auth){
          if(loginScreen) loginScreen.style.display = "none";
          if(mainEl) mainEl.style.display = "block";
          return;
        }
        const email = (loginEmail.value || "").trim();
        const pass  = (loginPass.value || "").trim();
        if(!email || !pass){
          loginError.textContent = "Complet√° email y contrase√±a.";
          return;
        }
        loginBtn.disabled = true;
        loginError.textContent = "";
        try{
          await auth.signInWithEmailAndPassword(email, pass);
        }catch(err){
          console.error("Error login:", err);
          loginError.textContent = "Usuario o contrase√±a incorrectos.";
        }finally{
          loginBtn.disabled = false;
        }
      });

      [loginEmail, loginPass].forEach(function(inp){
        inp.addEventListener("keydown", function(e){
          if(e.key === "Enter"){
            e.preventDefault();
            loginBtn.click();
          }
        });
      });
    }

    if(logoutBtn){
      logoutBtn.addEventListener("click", async function(){
        try{
          if(auth){
            await auth.signOut();
          }
        }catch(err){
          console.error("Error al cerrar sesi√≥n:", err);
        }
        if(loginScreen) loginScreen.style.display = "flex";
        if(mainEl) mainEl.style.display = "none";
      });
    }

    // ------------------ L√ìGICA APP ------------------ //
    const COLLECTION = "planificacion";
    const DOC_ID     = "planner_general";

    const MESES = ["","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const MESES_ABR = ["","ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];

    let state = {
      lineas: [],
      productos: [],
      datos: [],
      lineaTurnos: [],
      skuNotas: [],
      skuMarcados: []
    };

    // ‚úÖ filtros
    let skuQuery = "";
    let onlyMarked = false;

    let planEventsBound = false;

    // ‚úÖ pesta√±a activa (para reportes on-demand)
    let currentTab = "plan";

    // ================== AUTOSAVE PRO (sin spam) ================== //
    let saveTimer = null;
    let dirty = false;
    let lastSavedSig = "";

    function stableStringify(obj){
      return JSON.stringify(obj);
    }

    async function saveStateToFirebase(){
      if(!firebaseEnabled || !db) return;
      if(!dirty) return;

      const sig = stableStringify(state);
      if(sig === lastSavedSig){
        dirty = false;
        return;
      }

      try{
        const ref = db.collection(COLLECTION).doc(DOC_ID);
        await ref.set(state, { merge:true });
        lastSavedSig = sig;
        dirty = false;
      }catch(err){
        console.error("Error guardando en Firebase:", err);
        firebaseEnabled = false;
      }
    }

    function queueSaveFirebase(){
      if(!firebaseEnabled) return;
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(saveStateToFirebase, 1200);
    }

    function markDirtyAndQueueSave(){
      dirty = true;
      queueSaveFirebase();
    }

    function saveState(){
      markDirtyAndQueueSave();
    }

    // ================== REPORTES ON-DEMAND (performance fix) ================== //
    let reportesDirty = true;
    let reportesTimer = null;

    function scheduleRenderReportes(){
      reportesDirty = true;
      if(currentTab !== "reportes") return; // si no est√°s en reportes, ni gastes CPU
      if(reportesTimer) clearTimeout(reportesTimer);
      reportesTimer = setTimeout(function(){
        if(reportesDirty){
          renderReportes();
          reportesDirty = false;
        }
      }, 350);
    }

    // ================== Helpers ================== //
    function escapeHtml(str){
      return String(str || "").replace(/[&<>"']/g, function(s){
        return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s];
      });
    }

    function autoFitInputFont(inp){
      const len = (inp.value || "").length;
      if(len >= 10){
        inp.style.fontSize = "0.58rem";
      }else if(len >= 8){
        inp.style.fontSize = "0.62rem";
      }else if(len >= 6){
        inp.style.fontSize = "0.66rem";
      }else{
        inp.style.fontSize = "";
      }
    }

    function parseCodigoNum(c){
      const s = String(c ?? "").trim();
      if(/^\d+(\.\d+)?$/.test(s)) return Number(s);
      return null;
    }
    function compareCodigo(a, b){
      const na = parseCodigoNum(a);
      const nb = parseCodigoNum(b);
      if(na !== null && nb !== null) return na - nb;
      if(na !== null && nb === null) return -1;
      if(na === null && nb !== null) return 1;
      return String(a ?? "").localeCompare(String(b ?? ""), "es", { numeric:true, sensitivity:"base" });
    }

    // ‚úÖ Ventana 3 meses cruzando a√±o
    function buildVentana3Meses(anio, mesInicio){
      const out = [];
      for(let i=0;i<3;i++){
        const idx = (mesInicio - 1) + i;
        const mes = (idx % 12) + 1;
        const a   = anio + Math.floor(idx/12);
        out.push({ anio:a, mes:mes });
      }
      return out;
    }

    function getVentana(){
      if(!Array.isArray(ventanaMeses) || ventanaMeses.length!==3 || typeof ventanaMeses[0] === "number"){
        const baseYear = currentYear || (new Date()).getFullYear();
        const baseMonth = 1;
        return buildVentana3Meses(baseYear, baseMonth);
      }
      return ventanaMeses;
    }

    function findYearForMes(mes){
      const v = getVentana().find(x => x.mes === mes);
      return v ? v.anio : (currentYear || (new Date()).getFullYear());
    }

    async function loadStateFromFirebase(initial){
      if(!firebaseEnabled || !db) return;
      try{
        const ref = db.collection(COLLECTION).doc(DOC_ID);
        const snap = await ref.get();
        if(snap.exists){
          const data = snap.data() || {};
          state = {
            lineas: data.lineas || [],
            productos: data.productos || [],
            datos: data.datos || [],
            lineaTurnos: data.lineaTurnos || [],
            skuNotas: data.skuNotas || [],
            skuMarcados: data.skuMarcados || []
          };

          try{
            lastSavedSig = stableStringify(state);
            dirty = false;
          }catch(_e){}

          renderLineasHelpers();
          renderLineas();
          renderProductos();
          renderPlan();

          // reportes quedan ‚Äúsucios‚Äù hasta que entres a la pesta√±a (performance)
          reportesDirty = true;

          if(!initial) alert("‚úÖ Datos sincronizados desde Firebase.");
        }else{
          if(!initial) alert("No hay datos en Firebase todav√≠a.");
        }
      }catch(err){
        console.error("Error leyendo Firebase:", err);
        firebaseEnabled = false;
        if(!initial) alert("Error al leer de Firebase. Se seguir√° usando solo en esta sesi√≥n.");
      }
    }

    document.addEventListener("click", function(e){
      const btn = e.target.closest(".tab-btn");
      if(!btn) return;

      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      const tab = btn.getAttribute("data-tab");
      currentTab = tab;

      document.getElementById("tab-lineas").style.display    = tab==="lineas" ? "block":"none";
      document.getElementById("tab-productos").style.display = tab==="productos" ? "block":"none";
      document.getElementById("tab-plan").style.display      = tab==="plan" ? "block":"none";
      document.getElementById("tab-reportes").style.display  = tab==="reportes" ? "block":"none";

      // ‚úÖ render reportes SOLO cuando entr√°s (o si quedaron sucios)
      if(tab === "reportes"){
        if(reportesDirty){
          renderReportes();
          reportesDirty = false;
        }else{
          // por si quer√©s refresco igual
          scheduleRenderReportes();
        }
      }
    });

    // ------------------ DATA ACCESS ------------------ //
    function getDato(codigo, anio, mes){
      let d = (state.datos || []).find(function(x){
        return x.codigo_producto===codigo && x.anio===anio && x.mes===mes;
      });
      if(!d){
        d = {codigo_producto:codigo, anio:anio, mes:mes, stock_inicial:null, presupuesto:null, plan:null, turnos:null};
        state.datos.push(d);
      }
      return d;
    }

    function getLineaTurnos(linea, anio, mes){
      let r = (state.lineaTurnos || []).find(function(x){
        return x.linea===linea && x.anio===anio && x.mes===mes;
      });
      if(!r){
        r = {linea:linea, anio:anio, mes:mes, turnos_disponibles:null};
        state.lineaTurnos.push(r);
      }
      return r;
    }

    function findSkuNota(codigo){
      return (state.skuNotas || []).find(function(n){
        return n.codigo===codigo;
      });
    }

    function renderComentariosList(){
      const cont=document.getElementById("comentarios-list");
      if(!cont) return;
      cont.innerHTML = "";
    }

    // ------------------ L√çNEAS ------------------ //
    const tbodyLineas = document.getElementById("tbody-lineas");

    const datalistLineas = document.createElement("datalist");
    datalistLineas.id = "list-lineas";
    document.body.appendChild(datalistLineas);

    const selLineaPlan = document.getElementById("f-linea");
    const selLineaAlta = document.getElementById("p-linea");

    function lineasTotales(){
      const set = new Set(state.lineas || []);
      (state.productos || []).forEach(function(p){
        if(p.linea && p.linea.trim()!=="") set.add(p.linea.trim());
      });
      return Array.from(set).sort();
    }

    function renderLineas(){
      tbodyLineas.innerHTML = "";
      const lineas = (state.lineas || []).slice().sort((a,b)=>a.localeCompare(b));

      if(lineas.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = '<td class="sticky-left" colspan="2" style="text-align:left;">‚ö†Ô∏è No hay l√≠neas cargadas.</td>';
        tbodyLineas.appendChild(tr);
        return;
      }

      lineas.forEach(function(nombre){
        const tr = document.createElement("tr");
        tr.innerHTML = ''
          + '<td class="sticky-left" style="text-align:left;">'
          + '  <input class="cell-input linea-field" data-name="'+escapeHtml(nombre)+'" value="'+escapeHtml(nombre)+'" style="text-align:left;">'
          + '</td>'
          + '<td><button class="danger" data-del-linea="'+escapeHtml(nombre)+'">üóë</button></td>';
        tbodyLineas.appendChild(tr);
      });
    }

    document.getElementById("btn-add-linea").addEventListener("click", function(){
      const nombre = document.getElementById("l-nombre").value.trim();
      if(!nombre){
        alert("Escrib√≠ el nombre de la l√≠nea.");
        return;
      }
      if((state.lineas || []).includes(nombre)){
        alert("Esa l√≠nea ya existe.");
        return;
      }
      state.lineas.push(nombre);
      document.getElementById("l-nombre").value = "";
      markDirtyAndQueueSave();
      renderLineasHelpers();
      renderLineas();

      reportesDirty = true;
    });

    tbodyLineas.addEventListener("change", function(e){
      const inp = e.target.closest("input.linea-field");
      if(!inp) return;

      const oldName = inp.getAttribute("data-name");
      const newName = inp.value.trim();

      if(!newName){
        alert("El nombre de la l√≠nea no puede quedar vac√≠o.");
        renderLineas();
        return;
      }
      if(newName !== oldName && (state.lineas || []).includes(newName)){
        alert("Ya existe una l√≠nea con ese nombre.");
        renderLineas();
        return;
      }

      const idxReal = (state.lineas || []).indexOf(oldName);
      if(idxReal < 0){
        renderLineas();
        return;
      }

      state.lineas[idxReal] = newName;

      (state.productos || []).forEach(p=>{
        if((p.linea || "").trim() === oldName) p.linea = newName;
      });

      (state.lineaTurnos || []).forEach(r=>{
        if((r.linea || "").trim() === oldName) r.linea = newName;
      });

      markDirtyAndQueueSave();
      renderLineasHelpers();
      renderLineas();
      renderProductos();
      renderPlan();

      reportesDirty = true;
    });

    tbodyLineas.addEventListener("click", function(e){
      const btn = e.target.closest("button[data-del-linea]");
      if(!btn) return;

      const nombre = btn.getAttribute("data-del-linea");
      if(!confirm('¬øEliminar la l√≠nea "'+nombre+'"?')) return;

      state.lineas = (state.lineas || []).filter(l => l !== nombre);

      (state.productos || []).forEach(p=>{
        if((p.linea || "").trim() === nombre) p.linea = "";
      });

      state.lineaTurnos = (state.lineaTurnos || []).filter(r => (r.linea || "").trim() !== nombre);

      markDirtyAndQueueSave();
      renderLineasHelpers();
      renderLineas();
      renderProductos();
      renderPlan();

      reportesDirty = true;
    });

    function renderLineasHelpers(){
      datalistLineas.innerHTML = "";
      lineasTotales().forEach(function(l){
        const opt = document.createElement("option");
        opt.value = l;
        datalistLineas.appendChild(opt);
      });

      selLineaPlan.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Todas las l√≠neas";
      selLineaPlan.appendChild(optAll);
      lineasTotales().forEach(function(l){
        const o = document.createElement("option");
        o.value = l;
        o.textContent = l;
        selLineaPlan.appendChild(o);
      });

      if(selLineaAlta){
        const prev = selLineaAlta.value || "";
        selLineaAlta.innerHTML = "";
        const op0 = document.createElement("option");
        op0.value = "";
        op0.textContent = "‚Äî Seleccionar ‚Äî";
        selLineaAlta.appendChild(op0);
        lineasTotales().forEach(function(l){
          const o = document.createElement("option");
          o.value = l;
          o.textContent = l;
          selLineaAlta.appendChild(o);
        });
        if(prev && lineasTotales().includes(prev)) selLineaAlta.value = prev;
        else selLineaAlta.value = "";
      }
    }

    // ------------------ PRODUCTOS ------------------ //
    const tbodyProd = document.getElementById("tbody-prod");

    function renderProductos(){
      tbodyProd.innerHTML = "";
      if((state.productos || []).length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = '<td class="sticky-left" colspan="6" style="text-align:left;">‚ö†Ô∏è No hay productos. Carg√° manualmente o import√° un Excel.</td>';
        tbodyProd.appendChild(tr);
        return;
      }

      const ordenados = (state.productos || []).slice().sort(function(a,b){
        const la = (a.linea || "").localeCompare(b.linea || "");
        if(la!==0) return la;
        return compareCodigo(a.codigo, b.codigo);
      });

      ordenados.forEach(function(p){
        const idx = (state.productos || []).findIndex(x => x.codigo === p.codigo);
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td class="sticky-left" style="text-align:left;">'
          + '<input class="cell-input prod-field" data-field="codigo" data-idx="'+idx+'" value="'+escapeHtml(p.codigo)+'" style="text-align:left;">'
          + '</td>'
          + '<td class="sticky-left-2" style="text-align:left;">'
          + '<input class="cell-input prod-field" data-field="descripcion" data-idx="'+idx+'" value="'+escapeHtml(p.descripcion)+'" style="text-align:left;">'
          + '</td>'
          + '<td style="text-align:left;">'
          + '<input list="list-lineas" class="cell-input prod-field" data-field="linea" data-idx="'+idx+'" value="'+escapeHtml(p.linea || "")+'" style="text-align:left;">'
          + '</td>'
          + '<td><input class="cell-input prod-field" type="number" step="0.01" data-field="kg_caja" data-idx="'+idx+'" value="'+(p.kg_caja ?? "")+'"></td>'
          + '<td><input class="cell-input prod-field" type="number" data-field="cjs_turno" data-idx="'+idx+'" value="'+(p.cjs_turno ?? "")+'"></td>'
          + '<td><button class="danger" data-del-prod="'+idx+'">üóë</button></td>';
        tbodyProd.appendChild(tr);
      });
    }

    document.getElementById("btn-add-prod").addEventListener("click", function(){
      const codigo = document.getElementById("p-codigo").value.trim();
      const desc   = document.getElementById("p-desc").value.trim();
      const linea  = (document.getElementById("p-linea").value || "").trim();
      const kg     = document.getElementById("p-kg").value.trim();
      const cjs    = document.getElementById("p-cjs").value.trim();

      if(!codigo || !desc){
        alert("Complet√° al menos c√≥digo y descripci√≥n.");
        return;
      }
      if((state.productos || []).some(function(p){return p.codigo===codigo;})){
        alert("Ya existe un SKU con ese c√≥digo.");
        return;
      }

      state.productos.push({
        codigo: codigo,
        descripcion: desc,
        linea: linea,
        kg_caja: kg===""?null:Number(kg),
        cjs_turno: cjs===""?null:Number(cjs)
      });

      document.getElementById("p-codigo").value="";
      document.getElementById("p-desc").value="";
      document.getElementById("p-linea").value="";
      document.getElementById("p-kg").value="";
      document.getElementById("p-cjs").value="";

      markDirtyAndQueueSave();
      renderProductos();
      renderLineasHelpers();
      renderPlan();

      reportesDirty = true;
    });

    tbodyProd.addEventListener("change", function(e){
      const inp = e.target.closest("input.prod-field");
      if(!inp) return;
      const idx = Number(inp.getAttribute("data-idx"));
      const field = inp.getAttribute("data-field");
      let val = inp.value;
      if(field==="kg_caja" || field==="cjs_turno"){
        val = (val==="" ? null : Number(val));
      }
      state.productos[idx][field] = val;
      markDirtyAndQueueSave();
      renderLineasHelpers();
      renderPlan();

      reportesDirty = true;
    });

    tbodyProd.addEventListener("click", function(e){
      const btn = e.target.closest("button[data-del-prod]");
      if(!btn) return;
      const idx = Number(btn.getAttribute("data-del-prod"));
      const codigo = state.productos[idx].codigo;
      if(!confirm("¬øEliminar el SKU "+codigo+"?")) return;
      state.productos.splice(idx,1);
      state.datos = state.datos.filter(function(d){return d.codigo_producto!==codigo;});
      state.skuNotas = state.skuNotas.filter(function(n){return n.codigo!==codigo;});
      state.skuMarcados = state.skuMarcados.filter(function(c){return c!==codigo;});
      markDirtyAndQueueSave();
      renderProductos();
      renderPlan();

      reportesDirty = true;
    });

    document.getElementById("btn-clear-prod").addEventListener("click", function(){
      if(!confirm("‚ö†Ô∏è Esto borra productos y datos de planificaci√≥n. ¬øSeguro?")) return;
      state.productos = [];
      state.datos = [];
      state.skuNotas = [];
      state.skuMarcados = [];
      markDirtyAndQueueSave();
      renderProductos();
      renderPlan();

      reportesDirty = true;
    });

    document.getElementById("file-excel").addEventListener("change", function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data,{type:"array"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet,{defval:""});
        let agregados = 0;
        (rows || []).forEach(function(r){
          const codigo = String(r.CODIGO || "").trim();
          const desc   = String(r.DESCRIPCION || "").trim();
          const kg     = r.KG_X_CJA === "" ? null : Number(r.KG_X_CJA);
          const cjs    = r.CJS_X_TURNO === "" ? null : Number(r.CJS_X_TURNO);
          const linea  = String(r.LINEA || "").trim();
          if(!codigo || !desc) return;
          if((state.productos || []).some(function(p){return p.codigo===codigo;})) return;
          state.productos.push({codigo:codigo, descripcion:desc, linea:linea, kg_caja:kg, cjs_turno:cjs});
          if(linea && !(state.lineas || []).includes(linea)) state.lineas.push(linea);
          agregados++;
        });
        markDirtyAndQueueSave();
        alert("Importaci√≥n completa. SKUs nuevos: "+agregados);
        renderLineasHelpers();
        renderLineas();
        renderProductos();
        renderPlan();

        reportesDirty = true;
      };
      reader.readAsArrayBuffer(file);
    });

    // ------------------ PLAN / REPORTES ------------------ //
    const tablaPlan = document.getElementById("tabla-plan");
    const tablaReportes = document.getElementById("tabla-reportes");
    const tablaReportesAnual = document.getElementById("tabla-reportes-anual");

    let currentYear = (new Date()).getFullYear();
    let ventanaMeses = buildVentana3Meses(currentYear, 1);

    document.getElementById("f-anio").value = currentYear;
    document.getElementById("f-mes-inicio").value = 1;

    const inpSku = document.getElementById("f-sku");
    const chkOnlyMarked = document.getElementById("f-only-marked");

    if(inpSku){
      inpSku.addEventListener("input", function(){
        skuQuery = (inpSku.value || "").trim();
        renderPlan();
        reportesDirty = true;
      });
    }
    if(chkOnlyMarked){
      chkOnlyMarked.addEventListener("change", function(){
        onlyMarked = !!chkOnlyMarked.checked;
        renderPlan();
        reportesDirty = true;
      });
    }

    document.getElementById("btn-aplicar").addEventListener("click", function(){
      const a = Number(document.getElementById("f-anio").value) || (new Date()).getFullYear();
      const m = Number(document.getElementById("f-mes-inicio").value) || 1;

      currentYear = a;
      ventanaMeses = buildVentana3Meses(a, m);

      renderPlan();
      reportesDirty = true;
      scheduleRenderReportes();
    });

    document.getElementById("btn-guardar").addEventListener("click", async function(){
      dirty = true;
      await saveStateToFirebase();
      alert("‚úÖ Guardado en Firebase (si est√° disponible).");
    });

    document.getElementById("btn-export").addEventListener("click", exportarExcel);

    function moveVerticalInput(currentInput, direction){
      const td = currentInput.closest("td");
      if(!td) return;
      const colIndex = td.cellIndex;
      let tr = td.parentElement;
      while(tr){
        tr = (direction === -1) ? tr.previousElementSibling : tr.nextElementSibling;
        if(!tr) break;
        const cells = tr.children;
        if(colIndex >= cells.length) continue;
        const targetTd = cells[colIndex];
        if(!targetTd) continue;
        const nextInput = targetTd.querySelector("input.cell-input");
        if(nextInput){
          nextInput.focus();
          if(nextInput.select) nextInput.select();
          autoFitInputFont(nextInput);
          break;
        }
      }
    }

    function onPlanKeydownHandler(e){
      const inp = e.target.closest("input.cell-input");
      if(!inp) return;
      if(e.key === "ArrowUp"){
        e.preventDefault();
        moveVerticalInput(inp,-1);
      }else if(e.key === "ArrowDown"){
        e.preventDefault();
        moveVerticalInput(inp,1);
      }
    }

    function renderPlan(){
      if((state.productos || []).length===0){
        tablaPlan.innerHTML = '<thead><tr><th>‚ö†Ô∏è No hay productos en el maestro.</th></tr></thead>';
        renderComentariosList();
        return;
      }

      const lineaFiltro = selLineaPlan.value || "";
      const q = (skuQuery || "").toLowerCase();

      const productosFiltrados = state.productos
        .filter(function(p){
          if(lineaFiltro && (p.linea || "").trim() !== lineaFiltro) return false;

          if(onlyMarked){
            const marked = (state.skuMarcados || []).includes(p.codigo);
            if(!marked) return false;
          }

          if(q){
            const cod = String(p.codigo || "").toLowerCase();
            const des = String(p.descripcion || "").toLowerCase();
            if(!cod.includes(q) && !des.includes(q)) return false;
          }
          return true;
        })
        .slice()
        .sort(function(a,b){
          const la = (a.linea || "").localeCompare(b.linea || "");
          if(la!==0) return la;
          return compareCodigo(a.codigo, b.codigo);
        });

      if(productosFiltrados.length===0){
        tablaPlan.innerHTML = '<thead><tr><th>Sin productos para el filtro seleccionado.</th></tr></thead>';
        renderComentariosList();
        return;
      }

      const v = getVentana();
      const v1 = v[0], v2 = v[1], v3 = v[2];
      const m1 = v1.mes, m2 = v2.mes, m3 = v3.mes;
      const a1 = v1.anio, a2 = v2.anio, a3 = v3.anio;

      // ‚úÖ encabezados compactos (sin a√±o)
      const nom1 = MESES_ABR[m1];
      const nom2 = MESES_ABR[m2];
      const nom3 = MESES_ABR[m3];

      let thead = ''
        + '<thead>'
        + '<tr>'
        + '<th class="sticky-top sticky-left codigo-col" rowspan="2">C√≥digo</th>'
        + '<th class="sticky-top sticky-left-2" rowspan="2">Descripci√≥n</th>'
        + '<th class="sticky-top" colspan="4">üì¶ Presupuesto (PTO)</th>'
        + '<th class="sticky-top" colspan="4">üè≠ Plan (producci√≥n)</th>'
        + '<th class="sticky-top" colspan="4">üì¶ Stock fin</th>'
        + '<th class="sticky-top" colspan="4">‚è± Turnos (auto)</th>'
        + '</tr>'
        + '<tr>'
        + '<th class="sticky-top">'+nom1+'</th>'
        + '<th class="sticky-top">'+nom2+'</th>'
        + '<th class="sticky-top">'+nom3+'</th>'
        + '<th class="sticky-top">Tot</th>'
        + '<th class="sticky-top">'+nom1+'</th>'
        + '<th class="sticky-top">'+nom2+'</th>'
        + '<th class="sticky-top">'+nom3+'</th>'
        + '<th class="sticky-top">Tot</th>'
        + '<th class="sticky-top">Inicial</th>'
        + '<th class="sticky-top">'+nom1+'</th>'
        + '<th class="sticky-top">'+nom2+'</th>'
        + '<th class="sticky-top">'+nom3+'</th>'
        + '<th class="sticky-top">'+nom1+'</th>'
        + '<th class="sticky-top">'+nom2+'</th>'
        + '<th class="sticky-top">'+nom3+'</th>'
        + '<th class="sticky-top">Bal</th>'
        + '</tr>'
        + '</thead>';

      let body = "<tbody>";

      const grupos = {};
      productosFiltrados.forEach(function(p){
        const linea = (p.linea || "SIN L√çNEA").trim() || "SIN L√çNEA";
        if(!grupos[linea]) grupos[linea] = [];
        grupos[linea].push(p);
      });

      Object.keys(grupos).sort().forEach(function(linea){
        const g = grupos[linea];

        const isSinLinea = (linea === "SIN L√çNEA");
        const tL1 = isSinLinea ? {turnos_disponibles:null} : getLineaTurnos(linea,a1,m1);
        const tL2 = isSinLinea ? {turnos_disponibles:null} : getLineaTurnos(linea,a2,m2);
        const tL3 = isSinLinea ? {turnos_disponibles:null} : getLineaTurnos(linea,a3,m3);

        body += ''
          + '<tr class="line-header-row" data-linea="'+escapeHtml(linea)+'">'
          + '<td class="sticky-left line-header-cell codigo-col" style="text-align:left;"></td>'
          + '<td class="sticky-left-2 line-header-cell" style="text-align:left;">'+escapeHtml(linea)+'</td>'
          + '<td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td>'
          + '<td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td>'
          + '<td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td><td class="line-header-cell"></td>'
          + '<td class="turnos-disponibles-cell">'
          + '    <input class="cell-input linea-turnos" data-mes="'+m1+'" value="'+(tL1.turnos_disponibles ?? "")+'" '+(isSinLinea?'readonly':'')+'>'
          + '</td>'
          + '<td class="turnos-disponibles-cell">'
          + '    <input class="cell-input linea-turnos" data-mes="'+m2+'" value="'+(tL2.turnos_disponibles ?? "")+'" '+(isSinLinea?'readonly':'')+'>'
          + '</td>'
          + '<td class="turnos-disponibles-cell">'
          + '    <input class="cell-input linea-turnos" data-mes="'+m3+'" value="'+(tL3.turnos_disponibles ?? "")+'" '+(isSinLinea?'readonly':'')+'>'
          + '</td>'
          + '<td class="turnos-disponibles-cell linea-balance"></td>'
          + '</tr>';

        g.forEach(function(p){
          const d1 = getDato(p.codigo,a1,m1);
          const d2 = getDato(p.codigo,a2,m2);
          const d3 = getDato(p.codigo,a3,m3);

          const isMarked = (state.skuMarcados || []).includes(p.codigo);
          const skuNota = findSkuNota(p.codigo);
          const noteTitle = skuNota && skuNota.texto ? escapeHtml(skuNota.texto) : "Comentario SKU";
          const noteClass = skuNota && skuNota.texto ? " has-comment" : "";

          body += ''
            + '<tr data-codigo="'+escapeHtml(p.codigo)+'" data-linea="'+escapeHtml(linea)+'" class="'+(isMarked?'sku-row-marked':'')+'">'
            + '<td class="sticky-left codigo-col" style="text-align:left;">'
            + '  <div style="display:flex;flex-direction:column;gap:1px;">'
            + '    <div style="display:flex;align-items:center;gap:.25rem;">'
            + '      <span class="sku-code">'+escapeHtml(p.codigo)+'</span>'
            + '      <button class="mini-btn sku-mark-btn no-print" data-codigo="'+escapeHtml(p.codigo)+'" title="Marcar / desmarcar SKU">‚≠ê</button>'
            + '      <button class="mini-btn sku-note-btn no-print'+noteClass+'" data-codigo="'+escapeHtml(p.codigo)+'" title="'+noteTitle+'">üìù</button>'
            + '    </div>'
            + '  </div>'
            + '</td>'
            + '<td class="sticky-left-2" style="text-align:left;">'+escapeHtml(p.descripcion)+'</td>'
            + '<td><input class="cell-input plan-cell" data-field="presupuesto" data-mes="'+m1+'" value="'+(d1.presupuesto ?? "")+'"></td>'
            + '<td><input class="cell-input plan-cell" data-field="presupuesto" data-mes="'+m2+'" value="'+(d2.presupuesto ?? "")+'"></td>'
            + '<td><input class="cell-input plan-cell" data-field="presupuesto" data-mes="'+m3+'" value="'+(d3.presupuesto ?? "")+'"></td>'
            + '<td class="total-ppto total-cell-empty"></td>'
            + '<td><input class="cell-input plan-cell" data-field="plan" data-mes="'+m1+'" value="'+(d1.plan ?? "")+'"></td>'
            + '<td><input class="cell-input plan-cell" data-field="plan" data-mes="'+m2+'" value="'+(d2.plan ?? "")+'"></td>'
            + '<td><input class="cell-input plan-cell" data-field="plan" data-mes="'+m3+'" value="'+(d3.plan ?? "")+'"></td>'
            + '<td class="total-plan total-cell-empty"></td>'
            + '<td><input class="cell-input plan-cell" data-field="stock_inicial" data-mes="'+m1+'" value="'+(d1.stock_inicial ?? "")+'"></td>'
            + '<td class="sf1 stock-cell"></td>'
            + '<td class="sf2 stock-cell"></td>'
            + '<td class="sf3 stock-cell"></td>'
            + '<td class="turno1"></td>'
            + '<td class="turno2"></td>'
            + '<td class="turno3"></td>'
            + '<td class="total-turnos total-cell-empty"></td>'
            + '</tr>';
        });

        body += ''
          + '<tr class="line-subtotal-row" data-linea="'+escapeHtml(linea)+'">'
          + '<td class="sticky-left codigo-col" style="text-align:left;">Subtotal</td>'
          + '<td class="sticky-left-2" style="text-align:left;">'+escapeHtml(linea)+'</td>'
          + '<td class="sub-ppto1 total-cell-empty"></td>'
          + '<td class="sub-ppto2 total-cell-empty"></td>'
          + '<td class="sub-ppto3 total-cell-empty"></td>'
          + '<td class="sub-ppto-total total-cell-empty"></td>'
          + '<td class="sub-plan1 total-cell-empty"></td>'
          + '<td class="sub-plan2 total-cell-empty"></td>'
          + '<td class="sub-plan3 total-cell-empty"></td>'
          + '<td class="sub-plan-total total-cell-empty"></td>'
          + '<td></td><td></td><td></td><td></td>'
          + '<td class="sub-tur1 total-cell-empty"></td>'
          + '<td class="sub-tur2 total-cell-empty"></td>'
          + '<td class="sub-tur3 total-cell-empty"></td>'
          + '<td class="sub-tur-total total-cell-empty"></td>'
          + '</tr>';
      });

      body += "</tbody>";
      tablaPlan.innerHTML = thead + body;

      requestAnimationFrame(() => {
        const tr1 = tablaPlan.querySelector("thead tr:first-child");
        if(tr1){
          const h = tr1.getBoundingClientRect().height;
          tablaPlan.style.setProperty("--thead1h", Math.ceil(h) + "px");
        }
      });

      tablaPlan.querySelectorAll("input.cell-input").forEach(autoFitInputFont);

      if(!planEventsBound){
        tablaPlan.addEventListener("change", onPlanChangeHandler);
        tablaPlan.addEventListener("click", onPlanClickHandler);
        tablaPlan.addEventListener("keydown", onPlanKeydownHandler);
        planEventsBound = true;
      }

      recalcularTodo();
      renderComentariosList();
    }

    function onPlanChangeHandler(e){
      const inp = e.target;

      if(inp.classList.contains("linea-turnos")){
        const tr = inp.closest("tr.line-header-row");
        if(!tr) return;
        const linea = tr.getAttribute("data-linea");
        const mes = Number(inp.getAttribute("data-mes"));
        const anioDato = findYearForMes(mes);

        let val = inp.value;
        if(val==="") val=null; else val = Number(val);

        const r = getLineaTurnos(linea, anioDato, mes);
        r.turnos_disponibles = val;

        autoFitInputFont(inp);
        recalcularTodo();
        markDirtyAndQueueSave();

        scheduleRenderReportes();
        return;
      }

      if(inp.classList.contains("plan-cell")){
        const tr = inp.closest("tr[data-codigo]");
        if(!tr) return;
        const codigo = tr.getAttribute("data-codigo");
        const field  = inp.getAttribute("data-field");
        const mes    = Number(inp.getAttribute("data-mes"));
        const anioDato = findYearForMes(mes);

        let val = inp.value;
        if(val==="") val=null; else val = Number(val);

        const d = getDato(codigo, anioDato, mes);
        d[field] = val;

        autoFitInputFont(inp);
        recalcularTodo();
        markDirtyAndQueueSave();

        scheduleRenderReportes();
      }
    }

    function onPlanClickHandler(e){
      const btnMark = e.target.closest(".sku-mark-btn");
      if(btnMark){
        const codigo = btnMark.getAttribute("data-codigo");
        if(!state.skuMarcados) state.skuMarcados = [];
        const idx = state.skuMarcados.indexOf(codigo);
        if(idx>=0) state.skuMarcados.splice(idx,1);
        else state.skuMarcados.push(codigo);
        markDirtyAndQueueSave();
        renderPlan();

        reportesDirty = true;
        scheduleRenderReportes();
        return;
      }

      const btnNote = e.target.closest(".sku-note-btn");
      if(btnNote){
        const codigo = btnNote.getAttribute("data-codigo");
        const nota = findSkuNota(codigo);
        const actual = (nota && nota.texto) || "";
        const nuevo = prompt("Comentario para SKU "+codigo, actual);
        if(nuevo===null) return;

        if(!nuevo.trim()){
          if(nota){
            state.skuNotas = state.skuNotas.filter(function(n){return n.codigo!==codigo;});
          }
        }else{
          if(nota){
            nota.texto = nuevo.trim();
          }else{
            state.skuNotas.push({codigo:codigo, texto:nuevo.trim()});
          }
        }
        markDirtyAndQueueSave();
        renderPlan();

        reportesDirty = true;
        scheduleRenderReportes();
        return;
      }
    }

    function marcarStock(td, valor, presupuestoMes){
      td.classList.remove("stock-negative","stock-low");
      td.textContent = (valor || valor===0) ? valor.toLocaleString("es-AR") : "";
      if(valor===null || valor===undefined) return;
      if(valor < 0){
        td.classList.add("stock-negative");
      }else{
        const umbral = (presupuestoMes || 0) * 0.2;
        if(umbral > 0 && valor <= umbral){
          td.classList.add("stock-low");
        }
      }
    }

    function updateKpis(totalPpto,totalPlan,totalTurnos,totalTurnosDisp,totalStockM3){
      const cardT = document.getElementById("kpi-card-turnos");
      const fmt0 = n => (n || n===0) ? n.toLocaleString("es-AR",{maximumFractionDigits:0}) : "0";
      const fmt1 = n => (n || n===0) ? n.toLocaleString("es-AR",{maximumFractionDigits:1}) : "0.0";

      document.getElementById("kpi-pto").textContent = fmt0(totalPpto);
      document.getElementById("kpi-plan").textContent = fmt0(totalPlan);
      document.getElementById("kpi-stock").textContent = fmt0(totalStockM3);

      const v = getVentana();
      const last = v[2];
      const lastLabel = MESES[last.mes] + " " + last.anio;

      document.getElementById("kpi-pto-sub").textContent = totalPpto ? "Total PTO 3 meses (cajas)" : "";
      document.getElementById("kpi-plan-sub").textContent = totalPlan ? "Total plan 3 meses (cajas)" : "";
      document.getElementById("kpi-stock-sub").textContent = (totalStockM3 || totalStockM3===0) ? ("Suma stock fin " + lastLabel) : "";

      cardT.classList.remove("ok","warn","danger");
      if(totalTurnosDisp<=0 && totalTurnos<=0){
        document.getElementById("kpi-turnos").textContent = "‚Äì";
        document.getElementById("kpi-turnos-sub").textContent = "Sin turnos cargados";
      }else{
        const ratio = totalTurnos / (totalTurnosDisp || 1);
        const pct = ratio*100;
        document.getElementById("kpi-turnos").textContent = fmt1(totalTurnos)+" / "+fmt1(totalTurnosDisp);
        document.getElementById("kpi-turnos-sub").textContent = pct.toFixed(1)+"% de uso";
        if(pct < 90) cardT.classList.add("ok");
        else if(pct <= 100) cardT.classList.add("warn");
        else cardT.classList.add("danger");
      }
    }

    function recalcularTodo(){
      const v = getVentana();
      const v1 = v[0], v2 = v[1], v3 = v[2];
      const m1 = v1.mes, m2 = v2.mes, m3 = v3.mes;
      const a1 = v1.anio, a2 = v2.anio, a3 = v3.anio;

      const tbody = tablaPlan.querySelector("tbody");
      if(!tbody) return;

      const acumLinea = {};
      let totalPpto=0,totalPlan=0,totalTurnos=0,totalTurnosDisp=0,totalStockM3=0;

      tbody.querySelectorAll("tr[data-codigo]").forEach(function(tr){
        const codigo = tr.getAttribute("data-codigo");
        const linea  = tr.getAttribute("data-linea");
        const prod   = (state.productos || []).find(function(p){return p.codigo===codigo;}) || {};
        const cjsTurno = prod.cjs_turno || 0;

        const d1 = getDato(codigo,a1,m1);
        const d2 = getDato(codigo,a2,m2);
        const d3 = getDato(codigo,a3,m3);

        if(!acumLinea[linea]){
          acumLinea[linea] = { p1:0,p2:0,p3:0, pl1:0,pl2:0,pl3:0, t1:0,t2:0,t3:0 };
        }
        const a = acumLinea[linea];

        const tPpto = (d1.presupuesto||0)+(d2.presupuesto||0)+(d3.presupuesto||0);
        const cP = tr.querySelector(".total-ppto");
        cP.textContent = tPpto ? tPpto.toLocaleString("es-AR") : "";
        cP.className = "total-ppto "+(tPpto?"total-cell":"total-cell-empty");

        const tPlan = (d1.plan||0)+(d2.plan||0)+(d3.plan||0);
        const cPl = tr.querySelector(".total-plan");
        cPl.textContent = tPlan ? tPlan.toLocaleString("es-AR") : "";
        cPl.className = "total-plan "+(tPlan?"total-cell":"total-cell-empty");

        totalPpto += tPpto;
        totalPlan += tPlan;

        const si1 = d1.stock_inicial || 0;
        const sf1 = si1 + (d1.plan||0) - (d1.presupuesto||0);
        const sf2 = sf1 + (d2.plan||0) - (d2.presupuesto||0);
        const sf3 = sf2 + (d3.plan||0) - (d3.presupuesto||0);

        d2.stock_inicial = sf1;
        d3.stock_inicial = sf2;

        marcarStock(tr.querySelector(".sf1"), sf1, d1.presupuesto);
        marcarStock(tr.querySelector(".sf2"), sf2, d2.presupuesto);
        marcarStock(tr.querySelector(".sf3"), sf3, d3.presupuesto);

        totalStockM3 += sf3;

        let extraTurnsSku = 0;
        if(cjsTurno > 0){
          const faltantes = [];
          if(sf1 < 0) faltantes.push(-sf1);
          if(sf2 < 0) faltantes.push(-sf2);
          if(sf3 < 0) faltantes.push(-sf3);
          if(faltantes.length){
            const maxFalta = Math.max.apply(null,faltantes);
            extraTurnsSku = maxFalta / cjsTurno;
          }
        }
        const skuCodeSpan = tr.querySelector(".sku-code");
        if(skuCodeSpan){
          const skuCell = skuCodeSpan.parentElement.parentElement;
          let sugEl = skuCell.querySelector(".sku-sugg");
          if(extraTurnsSku > 0.001){
            if(!sugEl){
              sugEl = document.createElement("div");
              sugEl.className = "sku-sugg";
              skuCell.appendChild(sugEl);
            }
            sugEl.textContent = "+ "+extraTurnsSku.toFixed(2)+" turnos sugeridos";
          }else if(sugEl){
            sugEl.remove();
          }
        }

        let t1=0,t2=0,t3=0,totalT=0;
        if(cjsTurno>0){
          t1 = (d1.plan||0)/cjsTurno;
          t2 = (d2.plan||0)/cjsTurno;
          t3 = (d3.plan||0)/cjsTurno;
          totalT = t1+t2+t3;
          d1.turnos = t1;
          d2.turnos = t2;
          d3.turnos = t3;
        }
        tr.querySelector(".turno1").textContent = t1 ? t1.toFixed(2) : "";
        tr.querySelector(".turno2").textContent = t2 ? t2.toFixed(2) : "";
        tr.querySelector(".turno3").textContent = t3 ? t3.toFixed(2) : "";

        const cT = tr.querySelector(".total-turnos");
        cT.textContent = totalT ? totalT.toFixed(2) : "";
        cT.className = "total-turnos "+(totalT?"total-cell":"total-cell-empty");

        totalTurnos += totalT;

        a.p1  += (d1.presupuesto||0);
        a.p2  += (d2.presupuesto||0);
        a.p3  += (d3.presupuesto||0);
        a.pl1 += (d1.plan||0);
        a.pl2 += (d2.plan||0);
        a.pl3 += (d3.plan||0);
        a.t1  += t1;
        a.t2  += t2;
        a.t3  += t3;
      });

      tbody.querySelectorAll("tr.line-header-row").forEach(function(hr){
        const linea = hr.getAttribute("data-linea");
        const info = acumLinea[linea] || { t1:0,t2:0,t3:0 };
        const inputs = hr.querySelectorAll("input.linea-turnos");

        const disp1 = Number(inputs[0].value)||0;
        const disp2 = Number(inputs[1].value)||0;
        const disp3 = Number(inputs[2].value)||0;

        const totalDisp = disp1+disp2+disp3;
        const totalUsed = info.t1+info.t2+info.t3;
        const diff = totalDisp - totalUsed;

        totalTurnosDisp += totalDisp;

        const cellBalance = hr.querySelector(".linea-balance");
        cellBalance.classList.remove("ok","over");

        if(totalDisp===0 && totalUsed===0){
          cellBalance.textContent = "";
        }else if(diff>=0){
          cellBalance.textContent = "‚úÖ OK ¬∑ +"+diff.toFixed(2)+" libres";
          cellBalance.classList.add("ok");
        }else{
          const falta = Math.abs(diff);
          cellBalance.textContent = "‚ö† Excedido ¬∑ faltan "+falta.toFixed(2);
          cellBalance.classList.add("over");
        }
      });

      tbody.querySelectorAll("tr.line-subtotal-row").forEach(function(sr){
        const linea = sr.getAttribute("data-linea");
        const info = acumLinea[linea] || {p1:0,p2:0,p3:0,pl1:0,pl2:0,pl3:0,t1:0,t2:0,t3:0};

        const p1=info.p1||0, p2=info.p2||0, p3=info.p3||0;
        const pl1=info.pl1||0, pl2=info.pl2||0, pl3=info.pl3||0;
        const t1=info.t1||0, t2=info.t2||0, t3=info.t3||0;

        const pTotal = p1+p2+p3;
        const plTotal = pl1+pl2+pl3;
        const tTotal = t1+t2+t3;

        function setCell(cls,val){
          const c = sr.querySelector("."+cls);
          if(!c) return;
          c.textContent = val ? val.toLocaleString("es-AR",{maximumFractionDigits:2}) : "";
          c.className = cls+" "+(val ? "total-cell" : "total-cell-empty");
        }

        setCell("sub-ppto1",p1);
        setCell("sub-ppto2",p2);
        setCell("sub-ppto3",p3);
        setCell("sub-ppto-total",pTotal);

        setCell("sub-plan1",pl1);
        setCell("sub-plan2",pl2);
        setCell("sub-plan3",pl3);
        setCell("sub-plan-total",plTotal);

        setCell("sub-tur1",t1);
        setCell("sub-tur2",t2);
        setCell("sub-tur3",t3);
        setCell("sub-tur-total",tTotal);
      });

      updateKpis(totalPpto,totalPlan,totalTurnos,totalTurnosDisp,totalStockM3);

      // ‚úÖ performance fix: NO renderReportes() ac√°
      reportesDirty = true;
    }

    function exportarExcel(){
      recalcularTodo();

      if((state.productos || []).length===0){
        alert("No hay productos para exportar.");
        return;
      }

      const v = getVentana();
      const v1 = v[0], v2 = v[1], v3 = v[2];
      const m1 = v1.mes, m2 = v2.mes, m3 = v3.mes;
      const a1 = v1.anio, a2 = v2.anio, a3 = v3.anio;

      const nom1 = MESES[m1] + " " + a1;
      const nom2 = MESES[m2] + " " + a2;
      const nom3 = MESES[m3] + " " + a3;

      const lineaFiltro = selLineaPlan.value || "";
      const q = (skuQuery || "").toLowerCase();

      const productosFiltrados = (state.productos || [])
        .filter(function(p){
          if(lineaFiltro && (p.linea || "").trim() !== lineaFiltro) return false;

          if(onlyMarked){
            const marked = (state.skuMarcados || []).includes(p.codigo);
            if(!marked) return false;
          }

          if(q){
            const cod = String(p.codigo || "").toLowerCase();
            const des = String(p.descripcion || "").toLowerCase();
            if(!cod.includes(q) && !des.includes(q)) return false;
          }

          return true;
        })
        .slice()
        .sort(function(a,b){
          const la = (a.linea || "").localeCompare(b.linea || "");
          if(la!==0) return la;
          return compareCodigo(a.codigo, b.codigo);
        });

      if(productosFiltrados.length===0){
        alert("No hay productos para el filtro seleccionado.");
        return;
      }

      const lineaAgg = {};
      productosFiltrados.forEach(function(p){
        const linea = (p.linea || "SIN L√çNEA").trim() || "SIN L√çNEA";
        if(!lineaAgg[linea]){
          const tL1 = getLineaTurnos(linea,a1,m1);
          const tL2 = getLineaTurnos(linea,a2,m2);
          const tL3 = getLineaTurnos(linea,a3,m3);
          lineaAgg[linea] = {
            t1:0,t2:0,t3:0,
            disp1: tL1.turnos_disponibles || 0,
            disp2: tL2.turnos_disponibles || 0,
            disp3: tL3.turnos_disponibles || 0
          };
        }
        const agg = lineaAgg[linea];

        const d1 = getDato(p.codigo,a1,m1);
        const d2 = getDato(p.codigo,a2,m2);
        const d3 = getDato(p.codigo,a3,m3);

        const cjsTurno = p.cjs_turno || 0;
        if(cjsTurno>0){
          agg.t1 += (d1.plan || 0) / cjsTurno;
          agg.t2 += (d2.plan || 0) / cjsTurno;
          agg.t3 += (d3.plan || 0) / cjsTurno;
        }
      });

      Object.keys(lineaAgg).forEach(function(linea){
        const agg = lineaAgg[linea];
        const used = agg.t1 + agg.t2 + agg.t3;
        const disp = agg.disp1 + agg.disp2 + agg.disp3;
        const diff = disp - used;
        if(disp===0 && used===0){
          agg.balance = "";
        }else if(diff>=0){
          agg.balance = "OK +"+diff.toFixed(2)+" turnos libres";
        }else{
          agg.balance = "EXCEDIDO - faltan "+Math.abs(diff).toFixed(2)+" turnos";
        }
      });

      const aoa = [];
      aoa.push([
        "L√≠nea",
        "C√≥digo",
        "Descripci√≥n",
        "Kg/caja",
        "Cjs/turno",
        "PTO "+nom1+" (cjs)",
        "PTO "+nom2+" (cjs)",
        "PTO "+nom3+" (cjs)",
        "PTO Total (cjs)",
        "Plan "+nom1+" (cjs)",
        "Plan "+nom2+" (cjs)",
        "Plan "+nom3+" (cjs)",
        "Plan Total (cjs)",
        "Stock inicial "+nom1,
        "Stock fin "+nom1,
        "Stock fin "+nom2,
        "Stock fin "+nom3,
        "Turnos "+nom1,
        "Turnos "+nom2,
        "Turnos "+nom3,
        "Turnos Total",
        "Turnos disp. l√≠nea "+nom1,
        "Turnos disp. l√≠nea "+nom2,
        "Turnos disp. l√≠nea "+nom3,
        "Balance turnos l√≠nea"
      ]);

      productosFiltrados.forEach(function(p){
        const linea = (p.linea || "SIN L√çNEA").trim() || "SIN L√çNEA";
        const agg = lineaAgg[linea];

        const d1 = getDato(p.codigo,a1,m1);
        const d2 = getDato(p.codigo,a2,m2);
        const d3 = getDato(p.codigo,a3,m3);

        const ppto1 = d1.presupuesto || 0;
        const ppto2 = d2.presupuesto || 0;
        const ppto3 = d3.presupuesto || 0;
        const pptoTot = ppto1 + ppto2 + ppto3;

        const plan1 = d1.plan || 0;
        const plan2 = d2.plan || 0;
        const plan3 = d3.plan || 0;
        const planTot = plan1 + plan2 + plan3;

        const si1 = d1.stock_inicial || 0;
        const sf1 = si1 + plan1 - ppto1;
        const sf2 = sf1 + plan2 - ppto2;
        const sf3 = sf2 + plan3 - ppto3;

        const cjsTurno = p.cjs_turno || 0;
        let t1=0,t2=0,t3=0,tTot=0;
        if(cjsTurno>0){
          t1 = plan1 / cjsTurno;
          t2 = plan2 / cjsTurno;
          t3 = plan3 / cjsTurno;
          tTot = t1 + t2 + t3;
        }

        aoa.push([
          linea,
          p.codigo,
          p.descripcion,
          p.kg_caja || "",
          p.cjs_turno || "",
          ppto1,
          ppto2,
          ppto3,
          pptoTot,
          plan1,
          plan2,
          plan3,
          planTot,
          si1,
          sf1,
          sf2,
          sf3,
          Number(t1.toFixed(2)),
          Number(t2.toFixed(2)),
          Number(t3.toFixed(2)),
          Number(tTot.toFixed(2)),
          agg ? agg.disp1 : 0,
          agg ? agg.disp2 : 0,
          agg ? agg.disp3 : 0,
          agg ? agg.balance : ""
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, "Plan_3M");

      const filename = "plan_"+a1+"_"+m1+"-"+m3+".xlsx";
      XLSX.writeFile(wb, filename);
    }

    function renderReportes(){
      renderReportesTrimestral();
      renderReportesAnual();
    }

    function renderReportesTrimestral(){
      if(!tablaReportes) return;

      if((state.productos || []).length===0){
        tablaReportes.innerHTML = '<thead><tr><th>‚ö†Ô∏è No hay productos cargados.</th></tr></thead>';
        return;
      }

      const v = getVentana();
      const v1 = v[0], v2 = v[1], v3 = v[2];
      const m1 = v1.mes, m2 = v2.mes, m3 = v3.mes;
      const a1 = v1.anio, a2 = v2.anio, a3 = v3.anio;

      const nom1 = MESES[m1] + " " + a1;
      const nom2 = MESES[m2] + " " + a2;
      const nom3 = MESES[m3] + " " + a3;

      const grupos = {};
      (state.productos || []).forEach(function(p){
        const linea = (p.linea || "SIN L√çNEA").trim() || "SIN L√çNEA";
        const kgCaja = p.kg_caja || 0;
        if(!grupos[linea]){
          grupos[linea] = { ptoCjs:[0,0,0], planCjs:[0,0,0], ptoTn:[0,0,0], planTn:[0,0,0] };
        }
        const g = grupos[linea];
        const d1 = getDato(p.codigo,a1,m1);
        const d2 = getDato(p.codigo,a2,m2);
        const d3 = getDato(p.codigo,a3,m3);
        const pres = [d1.presupuesto||0,d2.presupuesto||0,d3.presupuesto||0];
        const plan = [d1.plan||0,d2.plan||0,d3.plan||0];
        for(var i=0;i<3;i++){
          g.ptoCjs[i]+=pres[i];
          g.planCjs[i]+=plan[i];
          const presKg = pres[i]*kgCaja;
          const planKg = plan[i]*kgCaja;
          g.ptoTn[i]+=presKg/1000;
          g.planTn[i]+=planKg/1000;
        }
      });

      const thead = ''
        + '<thead>'
        + '<tr>'
        + '<th rowspan="2">L√≠nea</th>'
        + '<th colspan="5">üì¶ PTO (cajas / tn)</th>'
        + '<th colspan="5">üè≠ Plan (cajas / tn)</th>'
        + '</tr>'
        + '<tr>'
        + '<th>'+nom1+' (cjs)</th>'
        + '<th>'+nom2+' (cjs)</th>'
        + '<th>'+nom3+' (cjs)</th>'
        + '<th>Total (cjs)</th>'
        + '<th>Total (tn)</th>'
        + '<th>'+nom1+' (cjs)</th>'
        + '<th>'+nom2+' (cjs)</th>'
        + '<th>'+nom3+' (cjs)</th>'
        + '<th>Total (cjs)</th>'
        + '<th>Total (tn)</th>'
        + '</tr>'
        + '</thead>';

      let body="<tbody>";
      let totPtoCjs=[0,0,0], totPlanCjs=[0,0,0], totPtoTn=0, totPlanTn=0;

      Object.keys(grupos).sort().forEach(function(linea){
        const g = grupos[linea];
        const ptoTotCjs = g.ptoCjs[0]+g.ptoCjs[1]+g.ptoCjs[2];
        const planTotCjs = g.planCjs[0]+g.planCjs[1]+g.planCjs[2];
        const ptoTotTn = g.ptoTn[0]+g.ptoTn[1]+g.ptoTn[2];
        const planTotTn = g.planTn[0]+g.planTn[1]+g.planTn[2];

        for(var i=0;i<3;i++){
          totPtoCjs[i]+=g.ptoCjs[i];
          totPlanCjs[i]+=g.planCjs[i];
        }
        totPtoTn += ptoTotTn;
        totPlanTn+= planTotTn;

        body += ''
          + '<tr>'
          + '<td style="text-align:left;">'+escapeHtml(linea)+'</td>'
          + '<td>'+(g.ptoCjs[0] ? g.ptoCjs[0].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.ptoCjs[1] ? g.ptoCjs[1].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.ptoCjs[2] ? g.ptoCjs[2].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(ptoTotCjs ? ptoTotCjs.toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(ptoTotTn ? ptoTotTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
          + '<td>'+(g.planCjs[0] ? g.planCjs[0].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.planCjs[1] ? g.planCjs[1].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.planCjs[2] ? g.planCjs[2].toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(planTotCjs ? planTotCjs.toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(planTotTn ? planTotTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
          + '</tr>';
      });

      const totPtoCjsTotal = totPtoCjs[0]+totPtoCjs[1]+totPtoCjs[2];
      const totPlanCjsTotal= totPlanCjs[0]+totPlanCjs[1]+totPlanCjs[2];

      body += ''
        + '<tr style="font-weight:700;background:#e5e7eb;">'
        + '<td style="text-align:left;">TOTAL PLANTA</td>'
        + '<td>'+(totPtoCjs[0] ? totPtoCjs[0].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPtoCjs[1] ? totPtoCjs[1].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPtoCjs[2] ? totPtoCjs[2].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPtoCjsTotal ? totPtoCjsTotal.toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPtoTn ? totPtoTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
        + '<td>'+(totPlanCjs[0] ? totPlanCjs[0].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPlanCjs[1] ? totPlanCjs[1].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPlanCjs[2] ? totPlanCjs[2].toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPlanCjsTotal ? totPlanCjsTotal.toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPlanTn ? totPlanTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
        + '</tr>';

      body += "</tbody>";
      tablaReportes.innerHTML = thead + body;
    }

    function renderReportesAnual(){
      if(!tablaReportesAnual) return;

      if((state.productos || []).length===0){
        tablaReportesAnual.innerHTML = '<thead><tr><th>‚ö†Ô∏è No hay productos cargados.</th></tr></thead>';
        return;
      }

      const grupos = {};
      (state.productos || []).forEach(function(p){
        const linea = (p.linea || "SIN L√çNEA").trim() || "SIN L√çNEA";
        const kgCaja = p.kg_caja || 0;
        if(!grupos[linea]){
          grupos[linea] = {ptoCjs:0, planCjs:0, ptoTn:0, planTn:0};
        }
        const g = grupos[linea];
        for(let mes=1; mes<=12; mes++){
          const d = (state.datos || []).find(function(x){
            return x.codigo_producto===p.codigo && x.anio===currentYear && x.mes===mes;
          });
          if(!d) continue;
          const pres = d.presupuesto||0;
          const plan = d.plan||0;
          g.ptoCjs += pres;
          g.planCjs += plan;
          g.ptoTn  += (pres*kgCaja)/1000;
          g.planTn += (plan*kgCaja)/1000;
        }
      });

      const thead = ''
        + '<thead>'
        + '<tr>'
        + '<th>L√≠nea</th>'
        + '<th>üì¶ PTO anual (cjs)</th>'
        + '<th>üì¶ PTO anual (tn)</th>'
        + '<th>üè≠ Plan anual (cjs)</th>'
        + '<th>üè≠ Plan anual (tn)</th>'
        + '</tr>'
        + '</thead>';

      let body = "<tbody>";
      let totPtoCjs=0, totPlanCjs=0, totPtoTn=0, totPlanTn=0;

      Object.keys(grupos).sort().forEach(function(linea){
        const g = grupos[linea];
        totPtoCjs += g.ptoCjs;
        totPlanCjs+= g.planCjs;
        totPtoTn  += g.ptoTn;
        totPlanTn += g.planTn;

        body += ''
          + '<tr>'
          + '<td style="text-align:left;">'+escapeHtml(linea)+'</td>'
          + '<td>'+(g.ptoCjs ? g.ptoCjs.toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.ptoTn ? g.ptoTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
          + '<td>'+(g.planCjs ? g.planCjs.toLocaleString("es-AR") : "")+'</td>'
          + '<td>'+(g.planTn ? g.planTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
          + '</tr>';
      });

      body += ''
        + '<tr style="font-weight:700;background:#e5e7eb;">'
        + '<td style="text-align:left;">TOTAL PLANTA</td>'
        + '<td>'+(totPtoCjs ? totPtoCjs.toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPtoTn ? totPtoTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
        + '<td>'+(totPlanCjs ? totPlanCjs.toLocaleString("es-AR") : "")+'</td>'
        + '<td>'+(totPlanTn ? totPlanTn.toLocaleString("es-AR",{maximumFractionDigits:2}) : "")+'</td>'
        + '</tr>';

      body += "</tbody>";
      tablaReportesAnual.innerHTML = thead + body;
    }

    // ------------------ INIT ------------------ //
    renderLineasHelpers();
    renderLineas();
    renderProductos();

    (function initVentanaDefault(){
      const now = new Date();
      currentYear = now.getFullYear();
      const mes = now.getMonth()+1;
      document.getElementById("f-anio").value = currentYear;
      document.getElementById("f-mes-inicio").value = mes;
      ventanaMeses = buildVentana3Meses(currentYear, mes);
    })();

    renderPlan();
  </script>
</body>
</html>
